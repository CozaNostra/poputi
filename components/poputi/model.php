<?php if(!defined('VALID_CMS')){die('ACCESS DENIED');}class cms_model_poputi{function __construct(){$this->form__=cmsDatabase::getInstance();}public function install(){return true;}public static function getConfig(){$form___=cmsCore::getinstance();$form____=$form___->loadComponentConfig("poputi");return $form____;}public function errors_pole($form_____){if($form_____['otkuda']==''){$form______ .= 'Вы не заполнили поле "Откуда".<br>';}if($form_____['kuda']==''){$form______ .= 'Вы не заполнили поле "Куда".<br>';}if($form_____['dni']==''){$form______ .= 'Вы не заполнили поле "Дни недели".<br>';}if($form_____['time_tuda']==''){$form______ .= 'Вы не заполнили поле "Отправление туда".<br>';}if($form_____['mobile']==''){$form______ .= 'Вы не заполнили поле "Контактный телефон".<br>';}return $form______;}public function editMarshrut($form_____,$form_______){$form________=cmsUser::getInstance();$form__=cmsDatabase::getInstance();$form_________=array('0','0','0','0','0','0','0');for($form__________=0;$form__________<=6;$form__________++){$form_________[$form_____['dni'][$form__________]-1]=$form_____['dni'][$form__________];$form___________ .= $form_________[$form__________] .'.';}$form___________=substr($form___________,0,-1);$form____________="UPDATE  `cms_poputi` SET `otkuda` = '{$form_____['otkuda']}' , `kuda`='{$form_____['kuda']}' ,`marshrut`='{$form_____['marshrut']}' , `napravlenie`='{$form_____['napravlenie']}' ,`dni`='{$form___________}' ,`cena`='{$form_____['cena']}',	`mobile`='{$form_____['mobile']}' ,`comments`='{$form_____['comments']}' WHERE `id`={$form_______};";$form__->query($form____________);for($form__________=1;$form__________<=7;$form__________++){if(!$form_____['time_tuda'][$form__________]){$form_____['time_tuda'][$form__________]='00:00';}if(!$form_____['time_ottuda'][$form__________]){$form_____['time_ottuda'][$form__________]='00:00';}if($form__________!=7){$form_____________ .=" `t{$form__________}` = '{$form_____['time_tuda'][$form__________]}' ,";$form______________ .=" `t{$form__________}` = '{$form_____['time_ottuda'][$form__________]}' ,";}else{$form_____________ .=" `t{$form__________}` = '{$form_____['time_tuda'][$form__________]}' ";$form______________ .=" `t{$form__________}` = '{$form_____['time_ottuda'][$form__________]}' ";}}$form____________="UPDATE `cms_poputi_time` SET {$form_____________} WHERE `id`={$form_______} ;";$form__->query($form____________);$form____________="UPDATE `cms_poputi_time1` SET {$form______________} WHERE `id`={$form_______} ;";$form__->query($form____________);return $form_______;}private function closeMarshrut(){$form___=cmsCore::getInstance();$form____=$form___->loadComponentConfig('poputi');$form_______________=$_SERVER['HTTP_HOST'];$form________________=strtoupper(md5(md5(str_replace('www.','',$form_______________) .'CozaNostra')));$form_________________=strtoupper($form________________);$form__________________[0]=substr($form_________________,0,8);$form__________________[1]=substr($form_________________,8,8);$form__________________[2]=substr($form_________________,16,8);$form__________________[3]=substr($form_________________,24,8);$form_________________=$form__________________[2] ."-" .$form__________________[1] ."-" .$form__________________[0] ."-" .$form__________________[3];if($form_________________==$form____['key']|| $form_______________=='127.0.0.1'|| $form_______________=='localhost'){return true;}else{return false;}}public function MarshrutStatus($form___________________=''){$form___=cmsCore::getInstance();$form________=cmsUser::getInstance();if(!$this->closeMarshrut()){$form___->mailText('cozanostra.me@ya.ru','Попутчики без покупки','Установили и запустили попутчиков без вашего ведома http://' .$_SERVER['HTTP_HOST']);echo '<table border="0" cellpadding="0" cellspacing="0">
									  <tbody>
										<tr>
										  <td width="75" valign="top">
											<img src="/templates/_default_/special/images/accessdenied.png">
										  </td>
										  <td style="padding-top:10px">
											<h1 class="con_heading">Доступ запрещен</h1>
											<p>Вы не покупали компонент "Попутчики".</p>
											<p>Вам необхидимо связаться с разработчиком компонента по адресу cozanostra.me@ya.ru.</p>
										  </td>
										</tr>
									  </tbody>
									</table>
					';return false;}if($form________->form____________________==9){echo '<table border="0" cellpadding="0" cellspacing="0">
									  <tbody>
										<tr>
										  <td width="75" valign="top">
											<img src="/templates/_default_/special/images/accessdenied.png">
										  </td>
										  <td style="padding-top:10px">
											<h1 class="con_heading">Доступ запрещен</h1>
											<p>Вы не имеете доступа к данной части сайта.</p>
											<p>Обратитесь к администрации сайта.</p>
										  </td>
										</tr>
									  </tbody>
									</table>';return false;}return 'cn_' .$form___________________;}public function form($form_____________________){return"
		
		<link href=\"/components/poputi/js/style.css\" rel=\"stylesheet\" type=\"text/css\" />
							<div style='position:relative;width:100%;height:150px;background: url(\"/components/poputi/images/bg.jpg\");'>
							<center>
							<h1>{$form_____________________}</h1>
							<form method=post class='block_poputi' style='padding:10px;' >
							Кем вы являетесь в сервисе \"Попутчики\": 
							<select name='user_poputi' >
							<option value=2 >Водитель</option>
							<option value=1 >Пассажир</option>
							<input style='margin-left:10px;' type='submit' value='Выбрать' >
							</select>
							</form>
							</center>
		<p style=\"position:absolute;bottom:0px;right:0px;;color:#ccc;font-size:10px;\" >CozaNostra &copy; Попутчики (v1.2) " .date('Y') ." г.</p>
		</div>
		";}public function addMarshrut($form_____){$form________=cmsUser::getInstance();$form__=cmsDatabase::getInstance();$form_________=array('0','0','0','0','0','0','0');for($form__________=0;$form__________<=6;$form__________++){$form_________[$form_____['dni'][$form__________]-1]=$form_____['dni'][$form__________];$form___________ .= $form_________[$form__________] .'.';}$form___________=substr($form___________,0,-1);$form_______=$form__->get_field('cms_poputi',' `id`!=0 ORDER BY  `id` DESC','id')+1;$form____________="INSERT INTO  `cms_poputi` (
															`id`,
															`user_id` ,
															`otkuda` ,
															`kuda` ,
															`marshrut` ,
															`napravlenie` ,
															`dni` ,
															`cena` ,
															`mobile` ,
															`comments`,
															`published`
															)
															VALUES (
															 '{$form_______}','{$form________->form_______}',  '{$form_____['otkuda']}',  '{$form_____['kuda']}',  '{$form_____['marshrut']}',  '{$form_____['napravlenie']}',  '{$form___________}',  '{$form_____['cena']}',  '{$form_____['mobile']}',  '{$form_____['comments']}', '0'
															);";$form__->query($form____________);$form____________="INSERT INTO `cms_poputi_time` (`id` ,
															`m_id` ,
															`t1` ,
															`t2` ,
															`t3` ,
															`t4` ,
															`t5` ,
															`t6` ,
															`t7` 
															)
															VALUES ('{$form_______}', '{$form________->form_______}', '{$form_____['time_tuda'][1]}', '{$form_____['time_tuda'][2]}', '{$form_____['time_tuda'][3]}', '{$form_____['time_tuda'][4]}', '{$form_____['time_tuda'][5]}', '{$form_____['time_tuda'][6]}', '{$form_____['time_tuda'][7]}'
															);";$form__->query($form____________);$form____________="INSERT INTO `cms_poputi_time1` (`id` ,
															`m_id` ,
															`t1` ,
															`t2` ,
															`t3` ,
															`t4` ,
															`t5` ,
															`t6` ,
															`t7` 
															)
															VALUES ('{$form_______}', '{$form________->form_______}', '{$form_____['time_ottuda'][1]}', '{$form_____['time_ottuda'][2]}', '{$form_____['time_ottuda'][3]}', '{$form_____['time_ottuda'][4]}', '{$form_____['time_ottuda'][5]}', '{$form_____['time_ottuda'][6]}', '{$form_____['time_ottuda'][7]}'
															);";$form__->query($form____________);return $form_______;}public function pubMarsrut($form_______,$form______________________,$form_______________________){$form________=cmsUser::getInstance();$form__=cmsDatabase::getInstance();if(!$form________->form________________________){$form____________="UPDATE  `cms_poputi` SET  `published` =  '{$form_______________________}' WHERE `id` ={$form_______} AND `user_id` ={$form______________________} LIMIT 1;";}else{$form____________="UPDATE  `cms_poputi` SET  `published` =  '{$form_______________________}' WHERE `id` ={$form_______} LIMIT 1;";}$form_________________________=$form__->query($form____________);return $form_________________________;}public function statusUser($form_______,$form__________________________){$form________=cmsUser::getInstance();$form__=cmsDatabase::getInstance();$form____________="UPDATE  `cms_users` SET  `poputi` =  '{$form__________________________}' WHERE `id` ={$form_______} LIMIT 1;";$form_________________________=$form__->query($form____________);return $form_________________________;}public function marshrutInfo($form_______){$form________=cmsUser::getInstance();$form__=cmsDatabase::getInstance();$form___________________________=$form__->get_fields('cms_poputi','`id`=' .$form_______,'*');$form___________________________['dni_ottuda']=$form__->get_fields('cms_poputi_time1','`id`=' .$form_______,'t1,t2,t3,t4,t5,t6,t7');$form____________________________='';$form_____________________________='';$form____________________________=explode(',',$form___________________________['marshrut']);for($form__________=0;$form__________<count($form____________________________);$form__________++){if($form__________==count($form____________________________)-1){$form_____________________________ .= "<a class='tags_poputi' href='/poputi/search?user_poputi=4&tag=1&query=" .urlencode(trim($form____________________________[$form__________])) ."' >" .trim($form____________________________[$form__________]) ."</a>";}else{$form_____________________________ .= "<a class='tags_poputi' href='/poputi/search?user_poputi=4&tag=1&query=" .urlencode(trim($form____________________________[$form__________])) ."' >" .trim($form____________________________[$form__________]) ."</a> ,";}}$form___________________________['marshrut']=$form_____________________________;$form___________________________['dni_tuda']=$form__->get_fields('cms_poputi_time','`id`=' .$form_______,'t1,t2,t3,t4,t5,t6,t7');$form______________________________=count($form___________________________['dni_tuda']);for($form__________=1;$form__________<=$form______________________________;$form__________++){$form___________________=explode(':',$form___________________________['dni_tuda']['t' .$form__________]);$form___________________________['dni_tuda']['t' .$form__________]=$form___________________[0] .':' .$form___________________[1];unset($form___________________);$form___________________=explode(':',$form___________________________['dni_ottuda']['t' .$form__________]);$form___________________________['dni_ottuda']['t' .$form__________]=$form___________________[0] .':' .$form___________________[1];}$form___________________________['dni']=explode('.',$form___________________________['dni']);unset($form_____________________________);return $form___________________________;}public function userInfo($form_______){$form__=cmsDatabase::getInstance();$form_______________________________=$form__->get_fields('cms_users','`id`=' .$form_______,'*');$form_______________________________['ava']=$form__->get_field('cms_user_profiles','`user_id`=' .$form_______,'imageurl');if(!$form_______________________________['ava']){$form_______________________________['ava']='nopic.jpg';}return $form_______________________________;}public function deleteMarshrut($form_______){$form________=cmsUser::getInstance();$form__=cmsDatabase::getInstance();$form____________="DELETE FROM `cms_poputi_time` WHERE `id` = {$form_______} AND `m_id`={$form________->form_______} LIMIT 1";$form________________________________=$form__->query($form____________);$form____________="DELETE FROM `cms_poputi_time1` WHERE `id` = {$form_______} AND `m_id`={$form________->form_______} LIMIT 1";$form_________________________________=$form__->query($form____________);$form____________="DELETE FROM `cms_poputi` WHERE `id` = {$form_______} AND `user_id`={$form________->form_______} LIMIT 1";$form_________________________=$form__->query($form____________);if($form_________________________ && $form________________________________ && $form_________________________________){return true;}else{return false;}}public function delAdminMarshrut($form_______){$form________=cmsUser::getInstance();$form__=cmsDatabase::getInstance();if($form________->form________________________){$form____________="DELETE FROM `cms_poputi_time` WHERE `id` = {$form_______} LIMIT 1";$form________________________________=$form__->query($form____________);$form____________="DELETE FROM `cms_poputi_time1` WHERE `id` = {$form_______} LIMIT 1";$form_________________________________=$form__->query($form____________);$form____________="DELETE FROM `cms_poputi` WHERE `id` = {$form_______} LIMIT 1";$form_________________________=$form__->query($form____________);if($form_________________________ && $form________________________________ && $form_________________________________){return true;}else{return false;}}else{return false;}}private function times_up($form__________________________________,$form___________________________________,$form_______){$form__=cmsDatabase::getInstance();$form____________________________________=date('w',strtotime(date('d.m.Y')));$form_____________________________________=$form__->get_field('cms_poputi_time','`id`=' .$form_______,'t' .$form____________________________________);$form______________________________________=$form__->get_field('cms_poputi','`id`=' .$form_______,'kuda');$form_______________________________________=$form__->get_field('cms_poputi_time1','`id`=' .$form_______,'t' .$form____________________________________);$form________________________________________=$form__->get_field('cms_poputi','`id`=' .$form_______,'kuda');if($form_____________________________________!='00:00:00'){if($form_____________________________________>$form___________________________________){$form__________________________________=explode(':',$form_____________________________________);$form_________________________________________=(int)($form__________________________________[0]*3600)+($form__________________________________[1]*60)+$form__________________________________[3];$form___________________________________=explode(':',$form___________________________________);$form__________________________________________=(int)($form___________________________________[0]*3600)+($form___________________________________[1]*60)+$form___________________________________[3];$form__________________________________=$form_________________________________________-$form__________________________________________;$form___________________________________________=floor($form__________________________________/3600);$form____________________________________________=floor(($form__________________________________/3600-$form___________________________________________)*60);$form_____________________________________________=ceil(($form____________________________________________-floor($form____________________________________________))*60);if($form___________________________________________){$form__________________________________='Выезд в пункт "<b>' .$form______________________________________ .'</b>" через ' .$form___________________________________________ .' ч. ' .$form____________________________________________ .' мин.';}else{$form__________________________________='Выезд в пункт "<b>' .$form______________________________________ .'</b>" через ' .$form____________________________________________ .' мин.';}return $form__________________________________;}if($form_______________________________________=='00:00:00'){return 'Уже уехал в пункт "<b>' .$form______________________________________ .'</b>"';}else{if($form_______________________________________>$form___________________________________){$form__________________________________=explode(':',$form_______________________________________);$form_________________________________________=(int)($form__________________________________[0]*3600)+($form__________________________________[1]*60)+$form__________________________________[3];$form___________________________________=explode(':',$form___________________________________);$form__________________________________________=(int)($form___________________________________[0]*3600)+($form___________________________________[1]*60)+$form___________________________________[3];$form__________________________________=$form_________________________________________-$form__________________________________________;$form___________________________________________=floor($form__________________________________/3600);$form____________________________________________=floor(($form__________________________________/3600-$form___________________________________________)*60);$form_____________________________________________=ceil(($form____________________________________________-floor($form____________________________________________))*60);if($form___________________________________________){$form__________________________________=$form___________________________________________ .' ч. ' .$form____________________________________________ .' мин.';}else{$form__________________________________=$form____________________________________________ .' мин.';}return 'Сегодня едет обратно из пункта "<b>' .$form________________________________________ .'</b>" через ' .$form__________________________________;}else{return 'Уже выехал обратно из пункта "<b>' .$form________________________________________ .'</b>"';}}}else{if($form_______________________________________!='00:00:00'){if($form_______________________________________>$form___________________________________){$form__________________________________=explode(':',$form_______________________________________);$form_________________________________________=(int)($form__________________________________[0]*3600)+($form__________________________________[1]*60)+$form__________________________________[3];$form___________________________________=explode(':',$form___________________________________);$form__________________________________________=(int)($form___________________________________[0]*3600)+($form___________________________________[1]*60)+$form___________________________________[3];$form__________________________________=$form_________________________________________-$form__________________________________________;$form___________________________________________=floor($form__________________________________/3600);$form____________________________________________=floor(($form__________________________________/3600-$form___________________________________________)*60);$form_____________________________________________=ceil(($form____________________________________________-floor($form____________________________________________))*60);if($form___________________________________________){$form__________________________________=$form___________________________________________ .' ч. ' .$form____________________________________________ .' мин.';}else{$form__________________________________=$form____________________________________________ .' мин.';}return 'Сегодня едет обратно из пункта "<b>' .$form________________________________________ .'</b>" через ' .$form__________________________________;}else{return 'Уже выехал обратно из пункта "<b>' .$form________________________________________ .'</b>"';}}else{return 'Сегодня не едет';}}}public function getMarshrut($form_______,$form______________________________________________,$form_______________________________________________,$form____________________________________=0){$form________=cmsUser::getInstance();$form__=cmsDatabase::getInstance();if($form_______________________________________________){$form________________________________________________="p.published=1 AND ";}$form___________________________________=date('H:i:s');if($form____________________________________!=0){$form_________________________________________________=",times.t{$form____________________________________} time_up";$form__________________________________________________="AND (times.t{$form____________________________________} >= '{$form___________________________________}' OR times1.t{$form____________________________________} >= '{$form___________________________________}')";}$form___________________________________________________=date('w',strtotime(date('d.m.Y')));$form____________="SELECT u.id,p.id mar_id, u.nickname, up.imageurl {$form_________________________________________________} , u.login ,p.otkuda,p.marshrut , p.kuda ,p.cena
						FROM `cms_users` u
						INNER JOIN cms_poputi p ON p.user_id = u.id
						INNER JOIN `cms_poputi_time` times ON times.id = p.id
						INNER JOIN `cms_poputi_time1` times1 ON times1.id = p.id
						INNER JOIN cms_user_profiles up ON up.user_id = u.id						
						WHERE {$form________________________________________________} u.poputi = {$form_______} {$form__________________________________________________} ORDER BY times.t{$form___________________________________________________}!='0' DESC,times.t{$form___________________________________________________} ASC  LIMIT {$form______________________________________________}";$form_________________________=$form__->query($form____________);while($form____________________________________________________=$form__->fetch_assoc($form_________________________)){$form____________________________='';$form_____________________________='';if(!$form____________________________________________________['imageurl']){$form____________________________________________________['imageurl']='nopic.jpg';}$form____________________________________________________['time_up']=$this->times_up($form____________________________________________________['time_up'],$form___________________________________,$form____________________________________________________['mar_id']);$form____________________________=explode(',',$form____________________________________________________['marshrut']);for($form__________=0;$form__________<count($form____________________________);$form__________++){if($form__________==count($form____________________________)-1){$form_____________________________ .= "<a class='tags_poputi' href='/poputi/search?tag=1&query=" .urlencode(trim($form____________________________[$form__________])) ."' >" .trim($form____________________________[$form__________]) ."</a>";}else{$form_____________________________ .= "<a class='tags_poputi' href='/poputi/search?tag=1&query=" .urlencode(trim($form____________________________[$form__________])) ."' >" .trim($form____________________________[$form__________]) ."</a> ,";}}$form____________________________________________________['marshrut']=$form_____________________________;$form_______________________________[]=$form____________________________________________________;}return $form_______________________________;}public function getCount($form_______,$form____,$form_____________________________________________________){$form________=cmsUser::getInstance();$form__=cmsDatabase::getInstance();$form____________="SELECT DISTINCT p.id FROM `cms_users`	u 
		INNER JOIN cms_poputi p ON p.user_id = u.id
		WHERE p.published ='1' AND u.poputi = '{$form_______}'";$form_________________________=$form__->query($form____________);while($form____________________________________________________=$form__->fetch_assoc($form_________________________)){$form______________________________________________________[]=$form____________________________________________________;}$form______________________________=count($form______________________________________________________);$form_____________________________________________________=($form_____________________________________________________-1)*$form____['max_count_page'];$form____________="SELECT DISTINCT p.id FROM `cms_users`	u 
		INNER JOIN cms_poputi p ON p.user_id = u.id
		WHERE p.published ='1' AND u.poputi = '{$form_______}' ORDER BY u.id DESC  LIMIT {$form_____________________________________________________} , {$form____['max_count_page']}";$form_________________________=$form__->query($form____________);while($form____________________________________________________=$form__->fetch_assoc($form_________________________)){$form_______________________________________________________[]=$form____________________________________________________;}$form_______________________________________________________['count']=$form______________________________;return $form_______________________________________________________;}}
